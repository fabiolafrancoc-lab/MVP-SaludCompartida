(()=>{var e={};e.id=978,e.ids=[978],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},59125:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>_,routeModule:()=>d,serverHooks:()=>g,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{POST:()=>p});var i=t(42706),s=t(28203),a=t(45994),n=t(39187),u=t(57886);async function p(e){try{let r=await e.text(),t=JSON.parse(r);return console.log("Square webhook event:",t.type),"payment.completed"===t.type&&await c(t.data?.object?.payment),n.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),n.NextResponse.json({error:"Webhook processing failed"},{status:500})}}async function c(e){if(!e)return;console.log("Payment completed:",e.id);let r=e.order_id,t=(0,u.AG)(),{data:o,error:i}=await t.from("registrations").select("*").eq("square_order_id",r).single();if(i||!o){console.error("Registration not found for order:",r);return}await t.from("registrations").update({subscription_status:"active",square_payment_id:e.id,square_customer_id:e.customer_id,activated_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("registration_id",o.registration_id),console.log("Registration activated:",o.codigo_familia);try{await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/notificaciones`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"activation",registrationId:o.registration_id,codigoFamilia:o.codigo_familia,suscriptorEmail:o.suscriptor_email,suscriptorNombre:o.suscriptor_nombre,suscriptorTelefono:o.suscriptor_telefono,usuarioPrincipalNombre:o.usuario_principal_nombre,usuarioPrincipalTelefono:o.usuario_principal_telefono,planName:o.plan_name})})}catch(e){console.error("Error sending notifications:",e)}}let d=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/webhooks/square/route",pathname:"/api/webhooks/square",filename:"route",bundlePath:"app/api/webhooks/square/route"},resolvedPagePath:"/home/runner/work/MVP-SaludCompartida/MVP-SaludCompartida/src/app/api/webhooks/square/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:l,workUnitAsyncStorage:m,serverHooks:g}=d;function _(){return(0,a.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:m})}},96487:()=>{},78335:()=>{},57886:(e,r,t)=>{"use strict";t.d(r,{AG:()=>s,yg:()=>a});var o=t(47752);let i=null;function s(){if(i)return i;let e=process.env.SUPABASE_URL||"https://rzmdekjegbdgitqekjee.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6bWRla2plZ2JkZ2l0cWVramVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY0NTQ2NDcsImV4cCI6MjA1MjAzMDY0N30.pPTn8F7vK0xQYq8YvH5FvXJaHZ0xF7UwJ4qJ5xKqHzQ";if(!e||!r)throw Error("Missing Supabase environment variables");return i=(0,o.UU)(e,r,{auth:{autoRefreshToken:!1,persistSession:!1}})}function a(){let e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",r="SC-";for(let t=0;t<6;t++)r+=e.charAt(Math.floor(Math.random()*e.length));return r}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[638,452,752],()=>t(59125));module.exports=o})();
"use strict";(()=>{var e={};e.id=141,e.ids=[141],e.modules={10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77598:e=>{e.exports=require("node:crypto")},84801:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>f,routeModule:()=>u,serverHooks:()=>h,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>g});var a={};t.r(a),t.d(a,{GET:()=>m,POST:()=>c});var i=t(42706),o=t(28203),n=t(45994),s=t(39187),l=t(57886),p=t(12015);async function c(e){try{let{suscriptor:r,usuarioPrincipal:t,usuariosAdicionales:a,planId:i,planName:o,planPrice:n}=await e.json();if(!r?.email||!t?.nombre||!t?.apellido||!t?.fechaNacimiento)return s.NextResponse.json({error:"Datos incompletos. Se requiere: nombre, apellido y fecha de nacimiento del usuario principal."},{status:400});let c=(0,l.yg)(),m=(0,l.AG)(),u=new Date,d=u.toLocaleDateString("es-MX",{year:"numeric",month:"long",day:"numeric"}),g=u.toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit",hour12:!0}),{data:h,error:f}=await m.from("registrations").insert({codigo_familia:c,migrant_name:r.nombre,migrant_email:r.email,migrant_phone:r.telefono,migrant_state:r.estado,principal_name:t.nombre,principal_phone:t.telefono,principal_relationship:t.parentesco,plan_id:i,plan_name:o,plan_price:n,status:"pending",created_at:new Date().toISOString()}).select().single();if(f)return console.error("Error creating registration:",f),s.NextResponse.json({error:"Error al crear registro"},{status:500});let _=h.id,x=[{...t,is_principal:!0},...(a||[]).filter(e=>e.nombre?.trim())];x.length>0&&await m.from("family_members").insert(x.map(e=>({registration_id:_,name:e.nombre,last_name:e.apellido||null,birth_date:e.fechaNacimiento||null,phone:e.telefono||null,relationship:e.parentesco,is_principal:e.is_principal||!1})));try{let e=r.nombre.split(" "),a=e[0],i=e.slice(1).join(" ")||e[0];await (0,p.j$)({migrantName:r.nombre,migrantEmail:r.email,codigoFamilia:c,planName:o,planPrice:n}),await (0,p.IA)({migrantName:a,migrantLastName:i,migrantEmail:r.email,migrantPhone:r.telefono,migrantState:r.estado,principalName:t.nombre,principalLastName:t.apellido,principalBirthDate:t.fechaNacimiento,principalPhone:t.telefono,codigoFamilia:c,planName:o,planPrice:n,familyMembersCount:x.length,activationDate:d,activationTime:g})}catch(e){console.error("Error sending emails:",e)}let v=`${process.env.NEXT_PUBLIC_APP_URL}/dashboard?nuevo=true&codigo=${c}`;return s.NextResponse.json({success:!0,registrationId:_,codigoFamilia:c,checkoutUrl:v})}catch(e){return console.error("Registration error:",e),s.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function m(e){let{searchParams:r}=new URL(e.url),t=r.get("codigo");if(!t)return s.NextResponse.json({error:"C\xf3digo requerido"},{status:400});let a=(0,l.AG)(),{data:i,error:o}=await a.from("registrations").select("*").eq("codigo_familia",t).single();return o||!i?s.NextResponse.json({error:"Registro no encontrado"},{status:404}):s.NextResponse.json({status:i.subscription_status,plan:i.plan_id,codigoFamilia:i.codigo_familia,fechaActivacion:i.activated_at})}let u=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/registro/route",pathname:"/api/registro",filename:"route",bundlePath:"app/api/registro/route"},resolvedPagePath:"/home/runner/work/MVP-SaludCompartida/MVP-SaludCompartida/src/app/api/registro/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:d,workUnitAsyncStorage:g,serverHooks:h}=u;function f(){return(0,n.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:g})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[638,452,752,691,744],()=>t(84801));module.exports=a})();
(()=>{var e={};e.id=536,e.ids=[536],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},38825:(e,t,o)=>{"use strict";o.r(t),o.d(t,{patchFetch:()=>f,routeModule:()=>P,serverHooks:()=>b,workAsyncStorage:()=>k,workUnitAsyncStorage:()=>C});var r={};o.r(r),o.d(r,{GET:()=>h,POST:()=>w});var a=o(42706),s=o(28203),n=o(45994),i=o(39187),l=o(47752);let c=require("@aws-sdk/client-s3"),d=require("https");var u=o.n(d);let p=new c.S3Client({region:process.env.AWS_REGION||"us-east-2",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID_LEGAL,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY_LEGAL}}),g=new c.S3Client({region:process.env.AWS_REGION||"us-east-2",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID_COMPANION,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY_COMPANION}});async function _(e){return new Promise((t,o)=>{u().get(e,e=>{if(200!==e.statusCode){o(Error(`Failed to download audio: ${e.statusCode}`));return}let r=[];e.on("data",e=>r.push(e)),e.on("end",()=>t(Buffer.concat(r))),e.on("error",o)}).on("error",o)})}async function A(e,t,o,r,a={}){let s=new c.PutObjectCommand({Bucket:t,Key:o,Body:r,ContentType:"audio/mpeg",Metadata:{...a,uploaded_at:new Date().toISOString()}});await e.send(s);let n=process.env.AWS_REGION||"us-east-2";return`https://${t}.s3.${n}.amazonaws.com/${o}`}async function S(e){let{id:t,recordingUrl:o,customer:r,createdAt:a,duration:s}=e;if(!o)throw Error("No recording URL provided");console.log(`[VAPI Audio] Processing call: ${t}`),console.log(`[VAPI Audio] Downloading from: ${o}`);let n=await _(o);console.log(`[VAPI Audio] Downloaded ${n.length} bytes`);let i=new Date(a),l=i.getFullYear(),c=String(i.getMonth()+1).padStart(2,"0"),d=String(i.getDate()).padStart(2,"0"),u=`calls/${l}/${c}/${d}/${t}`,S=`${u}/audio-full.mp3`,v={call_id:t,phone_number:r?.number||"unknown",duration_seconds:String(s||0),recorded_at:a};console.log("[VAPI Audio] Uploading to LEGAL bucket...");let w=await A(p,process.env.AWS_S3_BUCKET_LEGAL,S,n,v);console.log(`[VAPI Audio] Uploaded to LEGAL: ${w}`),console.log("[VAPI Audio] Uploading to ACTIVE bucket...");let m=await A(g,process.env.AWS_S3_BUCKET_COMPANION,S,n,v);return console.log(`[VAPI Audio] Uploaded to ACTIVE: ${m}`),{callId:t,s3LegalUrl:w,s3ActiveUrl:m,s3LegalKey:S,s3ActiveKey:S,audioSizeBytes:n.length,metadata:v}}let v=(0,l.UU)("https://rzmdekjegbdgitqekjee.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function w(e){try{let t=await e.json();console.log("[VAPI Webhook] Event received:",t.message?.type||t.type);let o=t.message?.type||t.type;switch(o){case"call-start":await m(t);break;case"call-end":await y(t);break;case"transcript":await I(t);break;case"hang":await E(t);break;default:console.log("[VAPI Webhook] Unhandled event type:",o)}return i.NextResponse.json({received:!0})}catch(e){return console.error("[VAPI Webhook] Error:",e),i.NextResponse.json({error:e.message},{status:500})}}async function m(e){let t=e.call,o=t?.id,r=t?.customer?.number;console.log(`[VAPI] Call started: ${o} to ${r}`);let{error:a}=await v.from("companion_calls").insert({call_id:o,phone_number:r,started_at:new Date().toISOString(),status:"in_progress",companion_type:"lupita",vapi_phone_number_id:t?.phoneNumberId});a&&console.error("[VAPI] Error saving call start:",a)}async function y(e){let t=e.call,o=t?.id,r=t?.recordingUrl,a=t?.transcript,s=t?.duration;console.log(`[VAPI] Call ended: ${o}, duration: ${s}s`),console.log(`[VAPI] Recording URL: ${r}`);let n=null;if(r)try{n=await S({id:o,recordingUrl:r,customer:t.customer,createdAt:t.createdAt||new Date().toISOString(),duration:s}),console.log("[VAPI] Audio saved to S3:",n)}catch(e){console.error("[VAPI] Error processing audio:",e)}let{error:i}=await v.from("companion_calls").update({ended_at:new Date().toISOString(),duration_seconds:s,status:"completed",transcript:a,vapi_recording_url:r,s3_legal_url:n?.s3LegalUrl,s3_active_url:n?.s3ActiveUrl,s3_legal_key:n?.s3LegalKey,s3_active_key:n?.s3ActiveKey,audio_size_bytes:n?.audioSizeBytes}).eq("call_id",o);i&&console.error("[VAPI] Error updating call end:",i)}async function I(e){let t=e.call?.id,o=e.transcript;console.log(`[VAPI] Transcript [${t}]:`,o?.text?.substring(0,50))}async function E(e){let t=e.call?.id;console.log(`[VAPI] User hung up: ${t}`),await v.from("companion_calls").update({hung_up_by:"user",hung_up_at:new Date().toISOString()}).eq("call_id",t)}async function h(){return i.NextResponse.json({status:"ok",service:"vapi-webhook",timestamp:new Date().toISOString()})}let P=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/vapi-webhook/route",pathname:"/api/vapi-webhook",filename:"route",bundlePath:"app/api/vapi-webhook/route"},resolvedPagePath:"/home/runner/work/MVP-SaludCompartida/MVP-SaludCompartida/src/app/api/vapi-webhook/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:k,workUnitAsyncStorage:C,serverHooks:b}=P;function f(){return(0,n.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:C})}},96487:()=>{},78335:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[638,452,752],()=>o(38825));module.exports=r})();